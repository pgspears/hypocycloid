<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupled Harmonic Oscillator Visualization | Accelerate Solutions</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Inter:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap');

        :root {
            --bg-deep: #000000;
            --bg-panel: rgba(10, 10, 14, 0.94);
            --bg-card: rgba(255, 255, 255, 0.03);
            --accent-coral: #e8927c;
            --accent-lavender: #b8a9c9;
            --accent-orange: #ff6b35;
            --accent-cyan: #4ecdc4;
            --accent-gold: #d4a574;
            --accent-blue: #5b8def;
            --accent-green: #4ade80;
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
            --border-glass: 1px solid rgba(255, 255, 255, 0.08);
            --font-display: 'Cormorant Garamond', serif;
            --font-main: 'Inter', sans-serif;
            --font-mono: 'IBM Plex Mono', monospace;
            --radius: 12px;
            --radius-sm: 8px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            height: 56px;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(20, 20, 25, 0.95) 0%, rgba(10, 10, 14, 0.9) 100%);
            border-bottom: var(--border-glass);
            z-index: 100;
        }

        .brand {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 500;
            font-style: italic;
            color: var(--accent-coral);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-coral) 0%, var(--accent-gold) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .header-center {
            display: flex;
            gap: 4px;
            background: rgba(255,255,255,0.04);
            padding: 4px;
            border-radius: 10px;
        }

        .mode-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: 7px;
            cursor: pointer;
            font-size: 0.78rem;
            font-family: var(--font-main);
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .mode-btn.active {
            background: linear-gradient(135deg, rgba(232, 146, 124, 0.25) 0%, rgba(212, 165, 116, 0.2) 100%);
            color: var(--accent-coral);
        }

        .header-actions { display: flex; gap: 8px; align-items: center; }

        .icon-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .icon-btn:hover {
            background: rgba(232, 146, 124, 0.15);
            color: var(--accent-coral);
            border-color: rgba(232, 146, 124, 0.3);
        }

        .icon-btn.active {
            background: rgba(232, 146, 124, 0.2);
            color: var(--accent-coral);
        }

        /* Main Layout */
        main {
            flex: 1;
            display: grid;
            grid-template-columns: 340px 1fr;
            height: calc(100vh - 56px);
            position: relative;
        }

        main.fullscreen { grid-template-columns: 0 1fr; }
        main.fullscreen aside { transform: translateX(-100%); }

        /* Sidebar */
        aside {
            background: var(--bg-panel);
            backdrop-filter: blur(30px);
            border-right: var(--border-glass);
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }

        aside::-webkit-scrollbar { width: 6px; }
        aside::-webkit-scrollbar-track { background: transparent; }
        aside::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

        .control-section {
            background: var(--bg-card);
            border: var(--border-glass);
            border-radius: var(--radius);
            padding: 14px;
        }

        .control-section h3 {
            font-family: var(--font-main);
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-section h3::before {
            content: '';
            width: 3px;
            height: 12px;
            background: linear-gradient(180deg, var(--accent-coral) 0%, var(--accent-gold) 100%);
            border-radius: 2px;
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group:last-child { margin-bottom: 0; }

        .control-group.highlight {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.08) 0%, rgba(78, 205, 196, 0.08) 100%);
            border: 1px solid rgba(74, 222, 128, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin: 0 -10px 12px -10px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.78rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 6px;
        }

        .value-display {
            font-family: var(--font-mono);
            color: var(--accent-coral);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .value-display.perfect {
            color: var(--accent-green);
        }

        .hint {
            font-size: 0.68rem;
            color: rgba(255,255,255,0.4);
            margin-top: 4px;
            font-style: italic;
        }

        /* Sliders */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            margin: 2px 0;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fff 0%, #ddd 100%);
            cursor: pointer;
            margin-top: -5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 0 2px rgba(232, 146, 124, 0.3);
            transition: var(--transition);
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 12px rgba(0,0,0,0.4), 0 0 0 3px rgba(232, 146, 124, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, rgba(232,146,124,0.4) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 2px;
        }

        input[type=range].coupling-slider::-webkit-slider-runnable-track {
            background: linear-gradient(90deg, 
                rgba(255,100,100,0.4) 0%, 
                rgba(74,222,128,0.6) 50%, 
                rgba(255,100,100,0.4) 100%);
        }

        /* Checkboxes */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 0.78rem;
            color: rgba(255,255,255,0.7);
            padding: 6px 0;
            transition: var(--transition);
        }

        .checkbox-wrapper:hover { color: #fff; }

        .custom-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .checkbox-wrapper input { display: none; }
        .checkbox-wrapper input:checked + .custom-checkbox {
            background: linear-gradient(135deg, var(--accent-coral) 0%, var(--accent-gold) 100%);
            border-color: var(--accent-coral);
        }

        .checkbox-wrapper input:checked + .custom-checkbox::after {
            content: '‚úì';
            color: #000;
            font-size: 11px;
            font-weight: bold;
        }

        /* Buttons */
        .btn {
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.75rem;
            font-family: var(--font-main);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-coral) 0%, var(--accent-gold) 100%);
            color: #000;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 20px rgba(232, 146, 124, 0.4);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.1);
        }

        .btn-snap {
            background: rgba(74, 222, 128, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(74, 222, 128, 0.3);
            padding: 6px 12px;
            font-size: 0.7rem;
        }

        .btn-snap:hover {
            background: rgba(74, 222, 128, 0.25);
        }

        .btn-record.recording {
            background: linear-gradient(135deg, #ff4466 0%, #ff6644 100%);
            animation: pulse-record 1.5s infinite;
        }

        @keyframes pulse-record {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 68, 102, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255, 68, 102, 0); }
        }

        /* Presets */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }

        .preset-btn {
            padding: 7px 5px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 6px;
            color: rgba(255,255,255,0.6);
            font-size: 0.68rem;
            cursor: pointer;
            font-family: var(--font-main);
            transition: var(--transition);
        }

        .preset-btn:hover {
            background: rgba(232, 146, 124, 0.15);
            border-color: rgba(232, 146, 124, 0.3);
            color: var(--accent-coral);
        }

        /* Theme selector */
        .theme-grid {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .theme-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-btn:hover { transform: scale(1.1); }
        .theme-btn.active { border-color: #fff; }

        /* Color picker */
        input[type="color"] {
            -webkit-appearance: none;
            width: 32px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
        }

        input[type="color"]::-webkit-color-swatch {
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Stage */
        .stage {
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        canvas { display: block; }

        /* Overlays */
        .info-display {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--font-display);
            font-style: italic;
            font-size: 1.8rem;
            color: var(--accent-coral);
            pointer-events: none;
            text-shadow: 0 0 30px rgba(232, 146, 124, 0.4);
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .info-display .label { color: rgba(255,255,255,0.5); font-size: 1.4rem; }

        .coupling-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--font-mono);
            font-size: 0.85rem;
            padding: 8px 16px;
            border-radius: 20px;
            pointer-events: none;
            transition: var(--transition);
        }

        .coupling-indicator.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .coupling-indicator.perfect {
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent-green);
            border: 1px solid rgba(74, 222, 128, 0.4);
        }

        .coupling-indicator.broken {
            background: rgba(255, 100, 100, 0.2);
            color: #ff9999;
            border: 1px solid rgba(255, 100, 100, 0.4);
        }

        .pause-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            color: rgba(255,255,255,0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .pause-indicator.visible { opacity: 1; }

        .controls-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.3);
            text-align: right;
        }

        .fps-counter {
            position: absolute;
            top: 16px;
            right: 16px;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: rgba(255,255,255,0.3);
        }

        /* Educational Panel */
        .edu-panel {
            position: fixed;
            top: 56px;
            right: 0;
            width: 520px;
            height: calc(100vh - 56px);
            background: var(--bg-panel);
            backdrop-filter: blur(30px);
            border-left: var(--border-glass);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 200;
            overflow-y: auto;
            padding: 28px;
        }

        .edu-panel.open { transform: translateX(0); }

        .edu-panel::-webkit-scrollbar { width: 6px; }
        .edu-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

        .edu-panel h2 {
            font-family: var(--font-display);
            font-size: 1.9rem;
            font-weight: 500;
            font-style: italic;
            color: var(--accent-coral);
            margin-bottom: 6px;
        }

        .edu-panel .subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .edu-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .edu-section:last-child { border-bottom: none; }

        .edu-section h3 {
            font-family: var(--font-display);
            font-size: 1.15rem;
            font-weight: 500;
            color: var(--accent-lavender);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .edu-section h3 .icon {
            width: 24px;
            height: 24px;
            background: rgba(184, 169, 201, 0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .edu-section p {
            font-size: 0.88rem;
            line-height: 1.75;
            color: rgba(255, 255, 255, 0.75);
            margin-bottom: 12px;
        }

        .edu-section ul {
            margin-left: 18px;
            margin-bottom: 12px;
        }

        .edu-section li {
            font-size: 0.85rem;
            line-height: 1.65;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 6px;
        }

        .math-box {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 18px 20px;
            margin: 14px 0;
            font-family: var(--font-mono);
        }

        .math-box .equation {
            color: var(--accent-coral);
            font-size: 1rem;
            margin: 8px 0;
            display: block;
        }

        .math-box .label {
            color: rgba(255, 255, 255, 0.45);
            font-size: 0.75rem;
            margin-top: 10px;
            font-family: var(--font-main);
        }

        .highlight-box {
            background: linear-gradient(135deg, rgba(232, 146, 124, 0.1) 0%, rgba(184, 169, 201, 0.1) 100%);
            border: 1px solid rgba(232, 146, 124, 0.2);
            border-radius: 10px;
            padding: 16px 18px;
            margin: 14px 0;
        }

        .highlight-box p { margin: 0; color: rgba(255, 255, 255, 0.85); }

        .highlight-box.green {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, rgba(78, 205, 196, 0.1) 100%);
            border: 1px solid rgba(74, 222, 128, 0.2);
        }

        .close-edu {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .close-edu:hover {
            background: rgba(232, 146, 124, 0.2);
            color: var(--accent-coral);
        }

        /* Keyboard shortcuts */
        .shortcuts-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 16px;
            font-size: 0.82rem;
        }

        .key {
            background: rgba(255,255,255,0.1);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--accent-coral);
        }

        .edu-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .edu-overlay.open { opacity: 1; visibility: visible; }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(30, 30, 35, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.85rem;
            color: #fff;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 900px) {
            main { grid-template-columns: 1fr; }
            aside {
                position: fixed;
                left: 0; top: 56px; bottom: 0;
                width: 320px;
                transform: translateX(-100%);
            }
            aside.open { transform: translateX(0); }
            .edu-panel { width: 100%; }
        }

        /* Demo Mode */
        .demo-btn {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.2) 0%, rgba(91, 141, 239, 0.2) 100%);
            border: 1px solid rgba(78, 205, 196, 0.4);
            color: var(--accent-cyan);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.78rem;
            font-family: var(--font-main);
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .demo-btn:hover {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.3) 0%, rgba(91, 141, 239, 0.3) 100%);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        }

        .demo-btn.active {
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
            color: #000;
            animation: demo-pulse 2s infinite;
        }

        @keyframes demo-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(78, 205, 196, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(78, 205, 196, 0.2); }
        }

        /* Demo Narration Overlay */
        .demo-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 80;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .demo-overlay.active {
            opacity: 1;
        }

        .demo-narration {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px 36px;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .demo-narration h3 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-style: italic;
            color: var(--accent-coral);
            margin-bottom: 10px;
        }

        .demo-narration p {
            font-size: 0.95rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.85);
            margin: 0;
        }

        .demo-narration .highlight {
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .demo-narration .math {
            font-family: var(--font-mono);
            color: var(--accent-gold);
            background: rgba(212, 165, 116, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .demo-progress {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .demo-progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: var(--transition);
        }

        .demo-progress-dot.active {
            background: var(--accent-cyan);
            box-shadow: 0 0 10px var(--accent-cyan);
        }

        .demo-progress-dot.complete {
            background: var(--accent-coral);
        }

        .demo-exit-hint {
            position: absolute;
            top: 80px;
            right: 30px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 14px;
            border-radius: 8px;
            pointer-events: auto;
            cursor: pointer;
            transition: var(--transition);
        }

        .demo-exit-hint:hover {
            background: rgba(255, 100, 100, 0.3);
            color: #fff;
        }

        .demo-chapter {
            position: absolute;
            top: 20px;
            left: 30px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: 2px;
            text-transform: uppercase;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 14px;
            border-radius: 8px;
        }

        /* Demo Math Display */
        .demo-math {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 24px;
            font-family: var(--font-mono);
            min-width: 320px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .demo-math-title {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            text-align: center;
        }

        .demo-math-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .demo-math-label {
            color: rgba(255, 255, 255, 0.6);
        }

        .demo-math-value {
            font-weight: 500;
        }

        .demo-math-value.coral { color: var(--accent-coral); }
        .demo-math-value.green { color: var(--accent-green); }
        .demo-math-value.gold { color: var(--accent-gold); }
        .demo-math-value.lavender { color: var(--accent-lavender); }
        .demo-math-value.cyan { color: var(--accent-cyan); }

        .demo-math-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 12px 0;
        }

        .demo-math-equation {
            text-align: center;
            padding: 10px;
            background: rgba(232, 146, 124, 0.1);
            border-radius: 8px;
            margin-top: 10px;
        }

        .demo-math-equation .formula {
            font-size: 1.1rem;
            color: var(--accent-coral);
        }

        .demo-math-equation .equals {
            color: rgba(255, 255, 255, 0.5);
            margin: 0 8px;
        }

        .demo-math-equation .result {
            color: var(--accent-cyan);
            font-size: 1.1rem;
        }

        .demo-math-status {
            text-align: center;
            margin-top: 12px;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .demo-math-status.perfect {
            background: rgba(74, 222, 128, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        .demo-math-status.broken {
            background: rgba(255, 100, 100, 0.15);
            color: #ff9999;
            border: 1px solid rgba(255, 100, 100, 0.3);
        }
    </style>
</head>
<body>
    <header>
        <div class="brand">
            <div class="brand-icon">‚óâ</div>
            Coupled Harmonic Oscillator
        </div>
        <div class="header-center">
            <button class="mode-btn active" data-mode="illusion">
                <span>‚óé</span> Phase Illusion
            </button>
            <button class="mode-btn" data-mode="hypocycloid">
                <span>‚ùã</span> Hypocycloid
            </button>
            <button class="mode-btn" data-mode="dual">
                <span>‚ßâ</span> Compare
            </button>
        </div>
        <div class="header-actions">
            <button class="demo-btn" id="btn-demo">‚ñ∂ Demo Mode</button>
            <button class="icon-btn" id="btn-screenshot" title="Screenshot (S)">üì∑</button>
            <button class="icon-btn" id="btn-fullscreen" title="Fullscreen (F)">‚õ∂</button>
            <button class="icon-btn" id="btn-edu" title="Learn the Math">üìê</button>
        </div>
    </header>

    <main id="main">
        <aside id="sidebar">
            <div class="control-section">
                <h3>Phase Coupling</h3>
                <div class="control-group highlight">
                    <div class="control-label">
                        <span>Phase-Angle Ratio (k)</span>
                        <span class="value-display" id="val-coupling">1.00</span>
                    </div>
                    <input type="range" class="coupling-slider" id="ctrl-coupling" min="0" max="3" value="1" step="0.01">
                    <div class="hint">k = 1.0 creates perfect circle illusion</div>
                    <div style="display: flex; gap: 6px; margin-top: 8px;">
                        <button class="btn btn-snap" data-snap="0">k=0</button>
                        <button class="btn btn-snap" data-snap="0.5">k=0.5</button>
                        <button class="btn btn-snap" data-snap="1">k=1 ‚úì</button>
                        <button class="btn btn-snap" data-snap="2">k=2</button>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>Geometry</h3>
                <div class="control-group">
                    <div class="control-label">
                        <span>Number of Oscillators (n)</span>
                        <span class="value-display" id="val-n">8</span>
                    </div>
                    <input type="range" id="ctrl-n" min="2" max="32" value="8" step="1">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Orbit Radius (R)</span>
                        <span class="value-display" id="val-radius">120</span>
                    </div>
                    <input type="range" id="ctrl-radius" min="30" max="220" value="120">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Global Phase Offset</span>
                        <span class="value-display" id="val-phase">0¬∞</span>
                    </div>
                    <input type="range" id="ctrl-phase" min="0" max="360" value="0" step="1">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Ball Size</span>
                        <span class="value-display" id="val-size">16</span>
                    </div>
                    <input type="range" id="ctrl-size" min="4" max="50" value="16">
                </div>
            </div>

            <div class="control-section">
                <h3>Animation</h3>
                <div class="control-group">
                    <div class="control-label">
                        <span>Angular Velocity (œâ)</span>
                        <span class="value-display" id="val-speed">1.0√ó</span>
                    </div>
                    <input type="range" id="ctrl-speed" min="0" max="4" value="1" step="0.1">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Line Length</span>
                        <span class="value-display" id="val-lineLen">500</span>
                    </div>
                    <input type="range" id="ctrl-lineLen" min="150" max="800" value="500">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Trail Length</span>
                        <span class="value-display" id="val-trail">0</span>
                    </div>
                    <input type="range" id="ctrl-trail" min="0" max="100" value="0">
                </div>
            </div>

            <div class="control-section">
                <h3>Visualization</h3>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="ctrl-showLines" checked>
                    <span class="custom-checkbox"></span>
                    Show Oscillation Axes
                </label>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="ctrl-showApparentCircle">
                    <span class="custom-checkbox"></span>
                    Show Apparent Circle
                </label>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="ctrl-showCircleCenter">
                    <span class="custom-checkbox"></span>
                    Show Orbiting Center
                </label>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="ctrl-showPolygon">
                    <span class="custom-checkbox"></span>
                    Connect Oscillators
                </label>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="ctrl-showGlow" checked>
                    <span class="custom-checkbox"></span>
                    Glow Effect
                </label>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="ctrl-showMath">
                    <span class="custom-checkbox"></span>
                    Show Live Equations
                </label>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="ctrl-reverseDir">
                    <span class="custom-checkbox"></span>
                    Reverse Direction
                </label>
            </div>

            <div class="control-section">
                <h3>Theme</h3>
                <div class="theme-grid">
                    <button class="theme-btn active" data-theme="dark" style="background: linear-gradient(135deg, #000 50%, #1a1a2e 50%)" title="Dark"></button>
                    <button class="theme-btn" data-theme="orange" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%)" title="Orange Glow"></button>
                    <button class="theme-btn" data-theme="purple" style="background: linear-gradient(135deg, #2d1b4e 0%, #1a0a2e 100%)" title="Purple Night"></button>
                    <button class="theme-btn" data-theme="ocean" style="background: linear-gradient(135deg, #0c2340 0%, #1a4a6e 100%)" title="Deep Ocean"></button>
                    <button class="theme-btn" data-theme="sunset" style="background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%)" title="Sunset"></button>
                    <button class="theme-btn" data-theme="matrix" style="background: linear-gradient(135deg, #001a00 0%, #003300 100%)" title="Matrix"></button>
                </div>
                <div class="control-group" style="margin-top: 12px;">
                    <div class="control-label">Ball Color</div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="color" id="ctrl-color" value="#ffffff">
                        <label class="checkbox-wrapper" style="padding: 0; font-size: 0.72rem;">
                            <input type="checkbox" id="ctrl-rainbowMode">
                            <span class="custom-checkbox"></span>
                            Rainbow
                        </label>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>Presets</h3>
                <div class="preset-grid">
                    <button class="preset-btn" data-preset="perfect">Perfect</button>
                    <button class="preset-btn" data-preset="broken">Broken</button>
                    <button class="preset-btn" data-preset="double">Double</button>
                    <button class="preset-btn" data-preset="chaos">Chaos</button>
                    <button class="preset-btn" data-preset="sync">In Sync</button>
                    <button class="preset-btn" data-preset="youtube">YouTube</button>
                    <button class="preset-btn" data-preset="hypnotic">Hypnotic</button>
                    <button class="preset-btn" data-preset="rainbow">Rainbow</button>
                    <button class="preset-btn" data-preset="slow">Slow-Mo</button>
                </div>
            </div>

            <div class="control-section" style="margin-top: auto; background: transparent; border: none; padding: 0;">
                <button class="btn btn-primary btn-record" id="btn-record" style="width: 100%;">
                    <span>‚óè</span> Start Recording
                </button>
                <button class="btn btn-secondary" id="btn-reset" style="width: 100%; margin-top: 8px;">
                    Reset Defaults
                </button>
            </div>
        </aside>

        <section class="stage" id="stage">
            <canvas id="canvas"></canvas>
            <div class="coupling-indicator" id="coupling-indicator">k = 1.00 ‚Äî Perfect Illusion</div>
            <div class="info-display">
                <span class="label">n =</span>
                <span id="n-value">8</span>
            </div>
            <div class="pause-indicator" id="pause-indicator">‚ùö‚ùö</div>
            <div class="fps-counter" id="fps-counter">60 FPS</div>
            <div class="controls-hint">
                Click to pause ‚Ä¢ Space to play/pause<br>
                Arrow keys to adjust ‚Ä¢ F for fullscreen
            </div>
        </section>
    </main>

    <!-- Educational Panel -->
    <div class="edu-overlay" id="edu-overlay"></div>
    <div class="edu-panel" id="edu-panel">
        <button class="close-edu" id="close-edu">√ó</button>
        
        <h2>Coupled Harmonic Oscillators</h2>
        <p class="subtitle">Exploring the phase relationships that create emergent circular motion from linear oscillations</p>

        <div class="edu-section">
            <h3><span class="icon">‚ú®</span> The Phenomenon</h3>
            <p><strong>Each oscillator moves only along a straight line through the center.</strong> No oscillator ever travels in a curve ‚Äî yet with the correct phase coupling, they collectively appear to rotate in a perfect circle!</p>
            <div class="highlight-box green">
                <p>The key parameter is <strong>k</strong>, the phase-angle coupling ratio. When k = 1, the phase of each oscillator exactly matches its line angle, creating the perfect circular illusion.</p>
            </div>
        </div>

        <div class="edu-section">
            <h3><span class="icon">üìê</span> The Mathematics</h3>
            <p>For <strong>n</strong> oscillators, each oscillator <em>i</em> (0 to n‚àí1) follows:</p>
            
            <div class="math-box">
                <div class="label">Line angle (fixed axis of oscillation):</div>
                <span class="equation">Œ±·µ¢ = œÄ √ó i / n</span>
                
                <div class="label" style="margin-top: 12px;">Phase offset (with coupling ratio k):</div>
                <span class="equation">œÜ·µ¢ = k √ó Œ±·µ¢</span>
                
                <div class="label" style="margin-top: 12px;">Distance from center (SHM):</div>
                <span class="equation">d·µ¢(t) = 2R √ó cos(œât ‚àí œÜ·µ¢)</span>
                
                <div class="label" style="margin-top: 12px;">Position:</div>
                <span class="equation">x·µ¢ = d·µ¢ √ó cos(Œ±·µ¢)</span>
                <span class="equation">y·µ¢ = d·µ¢ √ó sin(Œ±·µ¢)</span>
            </div>
        </div>

        <div class="edu-section">
            <h3><span class="icon">üéöÔ∏è</span> The Coupling Ratio (k)</h3>
            <p>The coupling ratio determines the relationship between each oscillator's phase and its line angle:</p>
            <ul>
                <li><strong>k = 0</strong> ‚Äî All oscillators in phase (synchronized), moving together</li>
                <li><strong>k = 0.5</strong> ‚Äî Half coupling, creates an elliptical pattern</li>
                <li><strong>k = 1</strong> ‚Äî Perfect coupling! œÜ = Œ± creates the circle illusion</li>
                <li><strong>k = 2</strong> ‚Äî Double phase offset, creates a different pattern</li>
                <li><strong>k = other</strong> ‚Äî Various interesting but "broken" patterns</li>
            </ul>
            <div class="highlight-box">
                <p>Experiment with the k slider to see how the collective pattern changes. Only k = 1 produces the perfect circular illusion!</p>
            </div>
        </div>

        <div class="edu-section">
            <h3><span class="icon">üî¨</span> Why k = 1 Works</h3>
            <p>When k = 1, each oscillator's phase equals its line angle (œÜ·µ¢ = Œ±·µ¢). This creates a special condition:</p>
            <ul>
                <li>At any instant, all oscillators lie on a circle of radius R</li>
                <li>The center of this apparent circle orbits at distance R from the true center</li>
                <li>Each oscillator's amplitude is 2R, allowing it to trace through the origin</li>
            </ul>
            <p>This is the mathematical inverse of projecting circular motion onto multiple lines ‚Äî here we reconstruct the circle from properly-phased linear motions!</p>
        </div>

        <div class="edu-section">
            <h3><span class="icon">‚å®Ô∏è</span> Keyboard Shortcuts</h3>
            <div class="shortcuts-grid">
                <span class="key">Space</span><span>Play / Pause</span>
                <span class="key">D</span><span>Start demo mode</span>
                <span class="key">Esc</span><span>Exit demo mode</span>
                <span class="key">F</span><span>Toggle fullscreen</span>
                <span class="key">S</span><span>Take screenshot</span>
                <span class="key">R</span><span>Reset to defaults</span>
                <span class="key">‚Üë ‚Üì</span><span>Adjust speed</span>
                <span class="key">‚Üê ‚Üí</span><span>Adjust phase</span>
                <span class="key">[ ]</span><span>Change oscillator count</span>
                <span class="key">K</span><span>Snap k to 1.0</span>
                <span class="key">L</span><span>Toggle axis lines</span>
            </div>
        </div>

        <div class="edu-section">
            <h3><span class="icon">üåç</span> Physical Applications</h3>
            <p>Coupled oscillator systems appear throughout physics and engineering:</p>
            <ul>
                <li><strong>Three-phase AC power</strong> ‚Äî Uses 120¬∞ phase offsets (k = 1 with n = 3)</li>
                <li><strong>Molecular vibrations</strong> ‚Äî Coupled atomic oscillators in crystals</li>
                <li><strong>Pendulum arrays</strong> ‚Äî Phase-coupled mechanical oscillators</li>
                <li><strong>Signal processing</strong> ‚Äî I/Q modulation and Fourier decomposition</li>
                <li><strong>Quantum mechanics</strong> ‚Äî Superposition of oscillator states</li>
            </ul>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Demo Overlay -->
    <div class="demo-overlay" id="demo-overlay">
        <div class="demo-chapter" id="demo-chapter">Chapter 1 of 12</div>
        <div class="demo-exit-hint" id="demo-exit">Press ESC or click to exit demo</div>
        
        <!-- Live Math Display -->
        <div class="demo-math" id="demo-math">
            <div class="demo-math-title">Live Parameters</div>
            <div class="demo-math-row">
                <span class="demo-math-label">Oscillators</span>
                <span class="demo-math-value coral" id="dm-n">n = 8</span>
            </div>
            <div class="demo-math-row">
                <span class="demo-math-label">Coupling Ratio</span>
                <span class="demo-math-value green" id="dm-k">k = 1.00</span>
            </div>
            <div class="demo-math-row">
                <span class="demo-math-label">Orbit Radius</span>
                <span class="demo-math-value gold" id="dm-r">R = 120px</span>
            </div>
            <div class="demo-math-row">
                <span class="demo-math-label">Angular Velocity</span>
                <span class="demo-math-value lavender" id="dm-omega">œâ = 1.0√ó</span>
            </div>
            <div class="demo-math-divider"></div>
            <div class="demo-math-equation">
                <span class="formula">œÜ·µ¢ = k √ó Œ±·µ¢</span>
                <span class="equals">=</span>
                <span class="result" id="dm-phase-eq">1.00 √ó Œ±·µ¢</span>
            </div>
            <div class="demo-math-status perfect" id="dm-status">
                ‚úì Perfect Circle Illusion
            </div>
        </div>
        
        <div class="demo-narration" id="demo-narration">
            <h3 id="demo-title">Welcome</h3>
            <p id="demo-text">Demo content here</p>
        </div>
        <div class="demo-progress" id="demo-progress"></div>
    </div>

    <script>
        class CoupledOscillatorApp {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.mode = 'illusion';
                this.t = 0;
                this.isPaused = false;
                this.isRecording = false;
                this.lastFrameTime = performance.now();
                this.frameCount = 0;
                this.fps = 60;
                
                this.trailHistory = [];
                
                // Demo mode
                this.demoMode = false;
                this.demoStep = 0;
                this.demoTimer = null;
                this.demoStartParams = null;
                this.initDemoSequence();
                
                this.themes = {
                    dark: { bg: '#000000', bgGradient: null },
                    orange: { bg: '#000', bgGradient: { type: 'radial', colors: ['#ff6b35', '#ff4500', '#cc3300'], radius: 2.5 } },
                    purple: { bg: '#0a0612', bgGradient: { type: 'radial', colors: ['#2d1b4e', '#1a0a2e', '#0a0612'], radius: 3 } },
                    ocean: { bg: '#0a1628', bgGradient: { type: 'radial', colors: ['#1a4a6e', '#0c2340', '#0a1628'], radius: 3 } },
                    sunset: { bg: '#1a0a0a', bgGradient: { type: 'radial', colors: ['#ff7e5f', '#feb47b', '#1a0a0a'], radius: 2.8 } },
                    matrix: { bg: '#000a00', bgGradient: { type: 'radial', colors: ['#003300', '#001a00', '#000a00'], radius: 3 } }
                };
                
                this.params = {
                    coupling: 1.0,  // The key parameter!
                    n: 8,
                    radius: 120,
                    phase: 0,
                    ballSize: 16,
                    speed: 1,
                    lineLength: 500,
                    trailLength: 0,
                    ballColor: '#ffffff',
                    theme: 'dark',
                    showLines: true,
                    showApparentCircle: false,
                    showCircleCenter: false,
                    showPolygon: false,
                    showGlow: true,
                    showMath: false,
                    reverseDir: false,
                    rainbowMode: false
                };

                this.presets = {
                    perfect: { coupling: 1.0, n: 8, radius: 120, phase: 0, speed: 1, ballSize: 16, trailLength: 0, theme: 'dark', rainbowMode: false },
                    broken: { coupling: 0.7, n: 8, radius: 120, phase: 0, speed: 1, ballSize: 16, trailLength: 30, theme: 'dark', rainbowMode: false },
                    double: { coupling: 2.0, n: 8, radius: 120, phase: 0, speed: 0.8, ballSize: 16, trailLength: 40, theme: 'purple', rainbowMode: false },
                    chaos: { coupling: 1.618, n: 16, radius: 140, phase: 0, speed: 1.5, ballSize: 10, trailLength: 50, theme: 'matrix', rainbowMode: true },
                    sync: { coupling: 0, n: 8, radius: 120, phase: 0, speed: 1, ballSize: 18, trailLength: 0, theme: 'dark', rainbowMode: false },
                    youtube: { coupling: 1.0, n: 8, radius: 150, phase: 0, speed: 0.8, ballSize: 22, trailLength: 0, theme: 'orange', rainbowMode: false },
                    hypnotic: { coupling: 1.0, n: 12, radius: 130, phase: 0, speed: 0.5, ballSize: 14, trailLength: 50, theme: 'purple', rainbowMode: false },
                    rainbow: { coupling: 1.0, n: 10, radius: 130, phase: 0, speed: 1, ballSize: 18, trailLength: 0, theme: 'dark', rainbowMode: true },
                    slow: { coupling: 1.0, n: 8, radius: 120, phase: 0, speed: 0.25, ballSize: 20, trailLength: 70, theme: 'ocean', rainbowMode: false }
                };

                // Hypocycloid params
                this.hypoParams = { R: 200, dPercent: 100 };
                this.hypoPath = [];

                this.resize();
                this.bindEvents();
                this.updateCouplingIndicator();
                this.loop();
            }

            resize() {
                const stage = document.getElementById('stage');
                this.width = stage.clientWidth;
                this.height = stage.clientHeight;
                this.canvas.width = this.width;
                this.canvas.height = this.height;
                this.centerX = this.width / 2;
                this.centerY = this.height / 2;
            }

            updateCouplingIndicator() {
                const indicator = document.getElementById('coupling-indicator');
                const isPerfect = Math.abs(this.params.coupling - 1.0) < 0.01;
                indicator.className = 'coupling-indicator ' + (isPerfect ? 'perfect' : 'broken');
                indicator.textContent = isPerfect 
                    ? `k = ${this.params.coupling.toFixed(2)} ‚Äî Perfect Illusion ‚úì`
                    : `k = ${this.params.coupling.toFixed(2)} ‚Äî Illusion Broken`;
                
                const display = document.getElementById('val-coupling');
                display.className = 'value-display' + (isPerfect ? ' perfect' : '');
            }

            bindEvents() {
                window.addEventListener('resize', () => this.resize());

                // Mode buttons
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.mode = btn.dataset.mode;
                        this.hypoPath = [];
                        this.trailHistory = [];
                    });
                });

                // Theme buttons
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.params.theme = btn.dataset.theme;
                    });
                });

                // Snap buttons for coupling
                document.querySelectorAll('.btn-snap').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.params.coupling = parseFloat(btn.dataset.snap);
                        document.getElementById('ctrl-coupling').value = this.params.coupling;
                        document.getElementById('val-coupling').textContent = this.params.coupling.toFixed(2);
                        this.updateCouplingIndicator();
                        this.trailHistory = [];
                        this.showToast(`Coupling set to k = ${this.params.coupling}`);
                    });
                });

                // Education panel
                const eduPanel = document.getElementById('edu-panel');
                const eduOverlay = document.getElementById('edu-overlay');
                const eduBtn = document.getElementById('btn-edu');
                const closeEdu = document.getElementById('close-edu');

                const toggleEdu = () => {
                    eduPanel.classList.toggle('open');
                    eduOverlay.classList.toggle('open');
                    eduBtn.classList.toggle('active');
                };

                eduBtn.addEventListener('click', toggleEdu);
                closeEdu.addEventListener('click', toggleEdu);
                eduOverlay.addEventListener('click', toggleEdu);

                // Fullscreen & Screenshot
                document.getElementById('btn-fullscreen').addEventListener('click', () => this.toggleFullscreen());
                document.getElementById('btn-screenshot').addEventListener('click', () => this.takeScreenshot());

                // Demo mode
                document.getElementById('btn-demo').addEventListener('click', () => {
                    if (this.demoMode) {
                        this.stopDemo();
                    } else {
                        this.startDemo();
                    }
                });
                document.getElementById('demo-exit').addEventListener('click', () => this.stopDemo());

                // Stage click to pause
                document.getElementById('stage').addEventListener('click', () => this.togglePause());

                // Sliders
                this.bindSlider('coupling', v => {
                    this.params.coupling = parseFloat(v);
                    this.updateCouplingIndicator();
                    this.trailHistory = [];
                }, v => parseFloat(v).toFixed(2));

                this.bindSlider('n', v => {
                    this.params.n = parseInt(v);
                    document.getElementById('n-value').textContent = v;
                    this.trailHistory = [];
                });
                this.bindSlider('radius', v => { this.params.radius = parseInt(v); this.trailHistory = []; });
                this.bindSlider('phase', v => this.params.phase = parseInt(v), v => v + '¬∞');
                this.bindSlider('size', v => this.params.ballSize = parseInt(v));
                this.bindSlider('speed', v => this.params.speed = parseFloat(v), v => v + '√ó');
                this.bindSlider('lineLen', v => this.params.lineLength = parseInt(v));
                this.bindSlider('trail', v => { this.params.trailLength = parseInt(v); if (v == 0) this.trailHistory = []; });

                // Color
                document.getElementById('ctrl-color').addEventListener('input', e => {
                    this.params.ballColor = e.target.value;
                });

                // Checkboxes
                const checkboxes = {
                    'ctrl-showLines': 'showLines',
                    'ctrl-showApparentCircle': 'showApparentCircle',
                    'ctrl-showCircleCenter': 'showCircleCenter',
                    'ctrl-showPolygon': 'showPolygon',
                    'ctrl-showGlow': 'showGlow',
                    'ctrl-showMath': 'showMath',
                    'ctrl-reverseDir': 'reverseDir',
                    'ctrl-rainbowMode': 'rainbowMode'
                };

                Object.entries(checkboxes).forEach(([id, param]) => {
                    document.getElementById(id).addEventListener('change', e => {
                        this.params[param] = e.target.checked;
                    });
                });

                // Presets
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const preset = this.presets[btn.dataset.preset];
                        if (preset) {
                            Object.assign(this.params, preset);
                            this.updateUI();
                            this.updateCouplingIndicator();
                            this.trailHistory = [];
                            this.showToast(`Preset: ${btn.textContent}`);
                        }
                    });
                });

                // Reset
                document.getElementById('btn-reset').addEventListener('click', () => {
                    Object.assign(this.params, this.presets.perfect);
                    this.params.ballColor = '#ffffff';
                    this.params.showLines = true;
                    this.params.showApparentCircle = false;
                    this.params.showCircleCenter = false;
                    this.params.showPolygon = false;
                    this.params.showGlow = true;
                    this.params.showMath = false;
                    this.params.reverseDir = false;
                    this.params.rainbowMode = false;
                    this.updateUI();
                    this.updateCouplingIndicator();
                    this.trailHistory = [];
                    this.showToast('Reset to defaults');
                });

                // Recording
                document.getElementById('btn-record').addEventListener('click', () => this.toggleRecord());

                // Keyboard shortcuts
                document.addEventListener('keydown', e => {
                    // ESC exits demo mode
                    if (e.key === 'Escape' && this.demoMode) {
                        this.stopDemo();
                        return;
                    }
                    
                    if (e.target.tagName === 'INPUT') return;
                    
                    // Don't process other shortcuts during demo
                    if (this.demoMode) return;
                    
                    switch(e.key.toLowerCase()) {
                        case ' ':
                            e.preventDefault();
                            this.togglePause();
                            break;
                        case 'f':
                            this.toggleFullscreen();
                            break;
                        case 's':
                            this.takeScreenshot();
                            break;
                        case 'r':
                            document.getElementById('btn-reset').click();
                            break;
                        case 'k':
                            this.params.coupling = 1.0;
                            this.updateUI();
                            this.updateCouplingIndicator();
                            this.trailHistory = [];
                            this.showToast('Coupling snapped to k = 1.0');
                            break;
                        case 'l':
                            this.params.showLines = !this.params.showLines;
                            document.getElementById('ctrl-showLines').checked = this.params.showLines;
                            break;
                        case 'c':
                            this.params.showApparentCircle = !this.params.showApparentCircle;
                            document.getElementById('ctrl-showApparentCircle').checked = this.params.showApparentCircle;
                            break;
                        case 'arrowup':
                            e.preventDefault();
                            this.params.speed = Math.min(4, this.params.speed + 0.1);
                            this.updateUI();
                            break;
                        case 'arrowdown':
                            e.preventDefault();
                            this.params.speed = Math.max(0, this.params.speed - 0.1);
                            this.updateUI();
                            break;
                        case 'arrowleft':
                            this.params.phase = (this.params.phase - 5 + 360) % 360;
                            this.updateUI();
                            break;
                        case 'arrowright':
                            this.params.phase = (this.params.phase + 5) % 360;
                            this.updateUI();
                            break;
                        case '[':
                            this.params.n = Math.max(2, this.params.n - 1);
                            document.getElementById('n-value').textContent = this.params.n;
                            this.updateUI();
                            this.trailHistory = [];
                            break;
                        case ']':
                            this.params.n = Math.min(32, this.params.n + 1);
                            document.getElementById('n-value').textContent = this.params.n;
                            this.updateUI();
                            this.trailHistory = [];
                            break;
                        case 'd':
                            this.startDemo();
                            break;
                    }
                });
            }

            bindSlider(id, callback, formatter = v => v) {
                const slider = document.getElementById('ctrl-' + id);
                const display = document.getElementById('val-' + id);
                if (slider && display) {
                    slider.addEventListener('input', () => {
                        callback(slider.value);
                        display.textContent = formatter(slider.value);
                    });
                }
            }

            updateUI() {
                const setSlider = (id, val, formatter = v => v) => {
                    const slider = document.getElementById('ctrl-' + id);
                    const display = document.getElementById('val-' + id);
                    if (slider) slider.value = val;
                    if (display) display.textContent = formatter(val);
                };

                setSlider('coupling', this.params.coupling, v => parseFloat(v).toFixed(2));
                setSlider('n', this.params.n);
                document.getElementById('n-value').textContent = this.params.n;
                setSlider('radius', this.params.radius);
                setSlider('phase', this.params.phase, v => v + '¬∞');
                setSlider('size', this.params.ballSize);
                setSlider('speed', this.params.speed, v => v + '√ó');
                setSlider('lineLen', this.params.lineLength);
                setSlider('trail', this.params.trailLength);

                document.getElementById('ctrl-color').value = this.params.ballColor;
                document.getElementById('ctrl-showLines').checked = this.params.showLines;
                document.getElementById('ctrl-showApparentCircle').checked = this.params.showApparentCircle;
                document.getElementById('ctrl-showCircleCenter').checked = this.params.showCircleCenter;
                document.getElementById('ctrl-showPolygon').checked = this.params.showPolygon;
                document.getElementById('ctrl-showGlow').checked = this.params.showGlow;
                document.getElementById('ctrl-showMath').checked = this.params.showMath;
                document.getElementById('ctrl-reverseDir').checked = this.params.reverseDir;
                document.getElementById('ctrl-rainbowMode').checked = this.params.rainbowMode;

                document.querySelectorAll('.theme-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.theme === this.params.theme);
                });
            }

            togglePause() {
                this.isPaused = !this.isPaused;
                document.getElementById('pause-indicator').classList.toggle('visible', this.isPaused);
            }

            toggleFullscreen() {
                document.getElementById('main').classList.toggle('fullscreen');
            }

            takeScreenshot() {
                const link = document.createElement('a');
                link.download = `coupled_oscillator_k${this.params.coupling}_n${this.params.n}_${Date.now()}.png`;
                link.href = this.canvas.toDataURL('image/png');
                link.click();
                this.showToast('Screenshot saved!');
            }

            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('visible');
                setTimeout(() => toast.classList.remove('visible'), 2000);
            }

            hslToRgb(h, s, l) {
                let r, g, b;
                if (s === 0) { r = g = b = l; }
                else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1/6) return p + (q - p) * 6 * t;
                        if (t < 1/2) return q;
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    };
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                return `rgb(${Math.round(r * 255)}, ${Math.round(g * 255)}, ${Math.round(b * 255)})`;
            }

            getBallColor(index, total) {
                if (this.params.rainbowMode) {
                    const hue = (index / total + this.t * 0.02) % 1;
                    return this.hslToRgb(hue, 0.8, 0.6);
                }
                return this.params.ballColor;
            }

            hexToRgba(hex, alpha) {
                if (hex.startsWith('rgb')) {
                    return hex.replace('rgb', 'rgba').replace(')', `, ${alpha})`);
                }
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }

            drawBackground() {
                const theme = this.themes[this.params.theme];
                this.ctx.fillStyle = theme.bg;
                this.ctx.fillRect(0, 0, this.width, this.height);

                if (theme.bgGradient) {
                    const grad = theme.bgGradient;
                    const radius = this.params.radius * grad.radius;
                    const gradient = this.ctx.createRadialGradient(
                        this.centerX, this.centerY, 0,
                        this.centerX, this.centerY, radius
                    );
                    grad.colors.forEach((color, i) => {
                        gradient.addColorStop(i / (grad.colors.length - 1), color);
                    });
                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(this.centerX, this.centerY, radius, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }

            draw() {
                this.drawBackground();

                // FPS
                this.frameCount++;
                const now = performance.now();
                if (now - this.lastFrameTime >= 1000) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFrameTime = now;
                    document.getElementById('fps-counter').textContent = `${this.fps} FPS`;
                }

                switch (this.mode) {
                    case 'illusion': this.drawIllusion(); break;
                    case 'hypocycloid': this.drawHypocycloid(); break;
                    case 'dual': this.drawDual(); break;
                }

                if (this.params.showMath) this.drawMathOverlay();
                if (this.isRecording) this.drawWatermark();
            }

            drawIllusion() {
                const cx = this.centerX;
                const cy = this.centerY;
                const n = this.params.n;
                const R = this.params.radius;
                const k = this.params.coupling;
                const lineLen = this.params.lineLength / 2;
                const globalPhase = this.params.phase * Math.PI / 180;
                const dir = this.params.reverseDir ? -1 : 1;

                // Apparent circle center (only valid for k=1)
                const circleCenterX = cx + R * Math.cos(dir * this.t + globalPhase);
                const circleCenterY = cy + R * Math.sin(dir * this.t + globalPhase);

                // Guide lines
                if (this.params.showLines) {
                    const isDark = ['dark', 'matrix'].includes(this.params.theme);
                    this.ctx.strokeStyle = isDark ? 'rgba(255, 255, 255, 0.12)' : 'rgba(0, 0, 0, 0.2)';
                    this.ctx.lineWidth = 1.5;

                    for (let i = 0; i < n; i++) {
                        const alpha = (Math.PI * i) / n;
                        this.ctx.beginPath();
                        this.ctx.moveTo(cx + Math.cos(alpha) * lineLen, cy + Math.sin(alpha) * lineLen);
                        this.ctx.lineTo(cx - Math.cos(alpha) * lineLen, cy - Math.sin(alpha) * lineLen);
                        this.ctx.stroke();
                    }
                }

                // Apparent circle (only meaningful for k‚âà1)
                if (this.params.showApparentCircle && Math.abs(k - 1) < 0.1) {
                    this.ctx.strokeStyle = 'rgba(74, 222, 128, 0.5)';
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([6, 6]);
                    this.ctx.beginPath();
                    this.ctx.arc(circleCenterX, circleCenterY, R, 0, Math.PI * 2);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                }

                // Orbiting center
                if (this.params.showCircleCenter && Math.abs(k - 1) < 0.1) {
                    this.ctx.strokeStyle = 'rgba(126, 184, 218, 0.3)';
                    this.ctx.lineWidth = 1;
                    this.ctx.setLineDash([4, 4]);
                    this.ctx.beginPath();
                    this.ctx.arc(cx, cy, R, 0, Math.PI * 2);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);

                    this.ctx.fillStyle = 'rgba(74, 222, 128, 0.8)';
                    this.ctx.beginPath();
                    this.ctx.arc(circleCenterX, circleCenterY, 6, 0, Math.PI * 2);
                    this.ctx.fill();
                }

                // Calculate positions with coupling ratio k
                const ballPositions = [];
                for (let i = 0; i < n; i++) {
                    const alpha = (Math.PI * i) / n;  // Line angle
                    const phi = k * alpha;             // Phase = k √ó line angle
                    const distance = 2 * R * Math.cos(dir * this.t - phi + globalPhase);
                    const x = cx + Math.cos(alpha) * distance;
                    const y = cy + Math.sin(alpha) * distance;
                    ballPositions.push({ x, y, alpha, index: i });
                }

                // Trail
                if (this.params.trailLength > 0) {
                    this.trailHistory.push(ballPositions.map(p => ({ x: p.x, y: p.y, index: p.index })));
                    const maxFrames = Math.floor(this.params.trailLength * 1.5);
                    while (this.trailHistory.length > maxFrames) this.trailHistory.shift();
                }

                // Draw trails
                if (this.params.trailLength > 0 && this.trailHistory.length > 1) {
                    this.trailHistory.forEach((frame, frameIdx) => {
                        const alpha = (frameIdx / this.trailHistory.length) * 0.5;
                        const size = this.params.ballSize * (0.3 + 0.7 * frameIdx / this.trailHistory.length);
                        frame.forEach(pos => {
                            const color = this.getBallColor(pos.index, n);
                            this.ctx.fillStyle = this.hexToRgba(color, alpha);
                            this.ctx.beginPath();
                            this.ctx.arc(pos.x, pos.y, size * 0.5, 0, Math.PI * 2);
                            this.ctx.fill();
                        });
                    });
                }

                // Polygon
                if (this.params.showPolygon && ballPositions.length > 2) {
                    const sorted = [...ballPositions].sort((a, b) => {
                        return Math.atan2(a.y - cy, a.x - cx) - Math.atan2(b.y - cy, b.x - cx);
                    });

                    this.ctx.strokeStyle = 'rgba(232, 146, 124, 0.5)';
                    this.ctx.fillStyle = 'rgba(232, 146, 124, 0.08)';
                    this.ctx.lineWidth = 1.5;
                    this.ctx.beginPath();
                    sorted.forEach((pos, i) => {
                        if (i === 0) this.ctx.moveTo(pos.x, pos.y);
                        else this.ctx.lineTo(pos.x, pos.y);
                    });
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.stroke();
                }

                // Balls
                ballPositions.forEach((pos, i) => {
                    const color = this.getBallColor(i, n);

                    if (this.params.showGlow) {
                        const gradient = this.ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, this.params.ballSize * 2.5);
                        gradient.addColorStop(0, this.hexToRgba(color, 0.5));
                        gradient.addColorStop(0.5, this.hexToRgba(color, 0.1));
                        gradient.addColorStop(1, 'transparent');
                        this.ctx.fillStyle = gradient;
                        this.ctx.beginPath();
                        this.ctx.arc(pos.x, pos.y, this.params.ballSize * 2.5, 0, Math.PI * 2);
                        this.ctx.fill();
                    }

                    const ballGrad = this.ctx.createRadialGradient(
                        pos.x - this.params.ballSize * 0.3, pos.y - this.params.ballSize * 0.3, 0,
                        pos.x, pos.y, this.params.ballSize
                    );
                    ballGrad.addColorStop(0, '#ffffff');
                    ballGrad.addColorStop(0.3, color);
                    ballGrad.addColorStop(1, this.hexToRgba(color, 0.8));

                    this.ctx.fillStyle = ballGrad;
                    this.ctx.beginPath();
                    this.ctx.arc(pos.x, pos.y, this.params.ballSize, 0, Math.PI * 2);
                    this.ctx.fill();
                });

                // Center
                if (!this.themes[this.params.theme].bgGradient) {
                    this.ctx.fillStyle = 'rgba(255, 255, 255, 0.25)';
                    this.ctx.beginPath();
                    this.ctx.arc(cx, cy, 3, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }

            drawHypocycloid() {
                const cx = this.centerX;
                const cy = this.centerY;
                const R = this.hypoParams.R;
                const nCusps = this.params.n;
                const r = R / nCusps;
                const d = r * (this.hypoParams.dPercent / 100);
                const pathRadius = R - r;
                const velocityRatio = pathRadius / r;
                const dir = this.params.reverseDir ? -1 : 1;

                const tShifted = dir * this.t + this.params.phase * Math.PI / 180;
                const rcx = pathRadius * Math.cos(tShifted);
                const rcy = pathRadius * Math.sin(tShifted);
                const spinAngle = velocityRatio * tShifted;
                const tx = pathRadius * Math.cos(tShifted) + d * Math.cos(spinAngle);
                const ty = pathRadius * Math.sin(tShifted) - d * Math.sin(spinAngle);

                this.hypoPath.push({ x: tx, y: ty });
                if (this.hypoPath.length > 3000) this.hypoPath.shift();

                // Outer circle
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.arc(cx, cy, R, 0, Math.PI * 2);
                this.ctx.stroke();

                // Path
                if (this.hypoPath.length > 1) {
                    this.ctx.strokeStyle = 'rgba(232, 146, 124, 0.7)';
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.moveTo(cx + this.hypoPath[0].x, cy + this.hypoPath[0].y);
                    for (let i = 1; i < this.hypoPath.length; i++) {
                        this.ctx.lineTo(cx + this.hypoPath[i].x, cy + this.hypoPath[i].y);
                    }
                    this.ctx.stroke();
                }

                // Rolling circle
                if (this.params.showLines) {
                    this.ctx.strokeStyle = 'rgba(184, 169, 201, 0.4)';
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.arc(cx + rcx, cy + rcy, r, 0, Math.PI * 2);
                    this.ctx.stroke();
                }

                // Tracer
                const color = this.getBallColor(0, 1);
                if (this.params.showGlow) {
                    const gradient = this.ctx.createRadialGradient(cx + tx, cy + ty, 0, cx + tx, cy + ty, this.params.ballSize * 3);
                    gradient.addColorStop(0, this.hexToRgba(color, 0.7));
                    gradient.addColorStop(0.4, this.hexToRgba(color, 0.2));
                    gradient.addColorStop(1, 'transparent');
                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(cx + tx, cy + ty, this.params.ballSize * 3, 0, Math.PI * 2);
                    this.ctx.fill();
                }

                this.ctx.fillStyle = color;
                this.ctx.beginPath();
                this.ctx.arc(cx + tx, cy + ty, this.params.ballSize, 0, Math.PI * 2);
                this.ctx.fill();
            }

            drawDual() {
                this.ctx.save();
                this.ctx.beginPath();
                this.ctx.rect(0, 0, this.width / 2, this.height);
                this.ctx.clip();
                const origCenterX = this.centerX;
                this.centerX = this.width / 4;
                const origRadius = this.params.radius;
                this.params.radius = Math.min(origRadius, this.width / 6);
                this.drawIllusion();
                this.params.radius = origRadius;
                this.centerX = origCenterX;
                this.ctx.restore();

                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.beginPath();
                this.ctx.moveTo(this.width / 2, 0);
                this.ctx.lineTo(this.width / 2, this.height);
                this.ctx.stroke();

                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                this.ctx.font = '12px Inter';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('COUPLED OSCILLATORS', this.width / 4, 30);
                this.ctx.fillText('HYPOCYCLOID', this.width * 3 / 4, 30);

                this.ctx.save();
                this.ctx.beginPath();
                this.ctx.rect(this.width / 2, 0, this.width / 2, this.height);
                this.ctx.clip();
                this.centerX = this.width * 3 / 4;
                this.hypoParams.R = Math.min(150, this.width / 6);
                this.drawHypocycloid();
                this.centerX = origCenterX;
                this.ctx.restore();
            }

            drawMathOverlay() {
                const padding = 16;
                const boxWidth = 290;
                const boxHeight = 155;

                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                this.ctx.fillRect(padding, padding + 50, boxWidth, boxHeight);
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.strokeRect(padding, padding + 50, boxWidth, boxHeight);

                this.ctx.font = '11px "IBM Plex Mono", monospace';
                this.ctx.textAlign = 'left';

                const isPerfect = Math.abs(this.params.coupling - 1.0) < 0.01;
                const lines = [
                    { text: `k = ${this.params.coupling.toFixed(2)} ${isPerfect ? '‚úì' : ''}`, color: isPerfect ? 'rgba(74,222,128,0.9)' : 'rgba(255,150,150,0.9)' },
                    { text: `n = ${this.params.n}`, color: 'rgba(232,146,124,0.9)' },
                    { text: `R = ${this.params.radius}px`, color: 'rgba(184,169,201,0.9)' },
                    { text: `œÜ = ${this.params.phase}¬∞`, color: 'rgba(212,165,116,0.9)' },
                    { text: `t = ${this.t.toFixed(2)} rad`, color: 'rgba(126,184,218,0.9)' },
                    { text: '', color: 'transparent' },
                    { text: `Œ±·µ¢ = œÄ √ó i / n`, color: 'rgba(255,255,255,0.5)' },
                    { text: `œÜ·µ¢ = k √ó Œ±·µ¢`, color: 'rgba(255,255,255,0.5)' }
                ];

                lines.forEach((line, i) => {
                    this.ctx.fillStyle = line.color;
                    this.ctx.fillText(line.text, padding + 14, padding + 68 + i * 17);
                });
            }

            drawWatermark() {
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                this.ctx.fillRect(12, this.height - 50, 200, 40);
                this.ctx.fillStyle = '#fff';
                this.ctx.font = '10px Inter';
                this.ctx.textAlign = 'left';
                this.ctx.fillText('Accelerate Solutions ¬© 2025', 20, this.height - 32);
                this.ctx.fillText(`k=${this.params.coupling.toFixed(2)} n=${this.params.n}`, 20, this.height - 18);
            }

            // ==================== DEMO MODE ====================
            
            initDemoSequence() {
                this.demoSequence = [
                    {
                        title: "Welcome to Coupled Harmonic Oscillators",
                        text: "This visualization demonstrates how <span class='highlight'>linear motion</span> can create the illusion of <span class='highlight'>circular motion</span> through precise phase relationships.",
                        duration: 5000,
                        params: { coupling: 1, n: 8, radius: 120, speed: 0.8, trailLength: 0, theme: 'dark', rainbowMode: false, showLines: true, showApparentCircle: false, showCircleCenter: false, showPolygon: false, showGlow: true },
                        transition: 1000
                    },
                    {
                        title: "The Key Parameter: k",
                        text: "The coupling ratio <span class='math'>k</span> determines each oscillator's phase offset. When <span class='math'>œÜ·µ¢ = k √ó Œ±·µ¢</span>, magic happens at <span class='highlight'>k = 1</span>.",
                        duration: 5500,
                        params: { coupling: 1, n: 8, showLines: true, showApparentCircle: true, showCircleCenter: true },
                        transition: 800
                    },
                    {
                        title: "Breaking the Illusion: k = 0",
                        text: "When <span class='math'>k = 0</span>, all oscillators move <span class='highlight'>in phase</span> ‚Äî they synchronize together, destroying the circular pattern.",
                        duration: 5500,
                        params: { coupling: 0, trailLength: 30, showApparentCircle: false, showCircleCenter: false },
                        transition: 1500
                    },
                    {
                        title: "Partial Coupling: k = 0.5",
                        text: "At <span class='math'>k = 0.5</span>, we get <span class='highlight'>half the phase offset</span> needed. Watch how the pattern becomes elliptical rather than circular.",
                        duration: 5500,
                        params: { coupling: 0.5, trailLength: 40 },
                        transition: 1500
                    },
                    {
                        title: "Perfect Illusion: k = 1",
                        text: "At <span class='math'>k = 1</span>, phase equals line angle: <span class='math'>œÜ·µ¢ = Œ±·µ¢</span>. Every ball moves in a straight line, yet together they form a <span class='highlight'>perfect rotating circle</span>!",
                        duration: 6000,
                        params: { coupling: 1, trailLength: 0, showApparentCircle: true, showCircleCenter: true, theme: 'purple' },
                        transition: 1500
                    },
                    {
                        title: "Trails Reveal the Truth",
                        text: "Enable trails to see the <span class='highlight'>actual paths</span> each oscillator takes. They're all perfectly straight lines through the center!",
                        duration: 5500,
                        params: { trailLength: 80, showLines: true, showApparentCircle: false, showCircleCenter: false },
                        transition: 1000
                    },
                    {
                        title: "Double Phase: k = 2",
                        text: "When <span class='math'>k = 2</span>, each oscillator has <span class='highlight'>twice the phase offset</span>. This creates fascinating interference patterns.",
                        duration: 5500,
                        params: { coupling: 2, trailLength: 50, theme: 'ocean' },
                        transition: 1500
                    },
                    {
                        title: "The Golden Ratio: k = œÜ",
                        text: "Using <span class='math'>k = 1.618</span> (the golden ratio) creates beautiful, <span class='highlight'>never-repeating patterns</span> ‚Äî mathematical chaos in motion!",
                        duration: 6000,
                        params: { coupling: 1.618, n: 12, trailLength: 60, rainbowMode: true, theme: 'matrix', speed: 1.2 },
                        transition: 1500
                    },
                    {
                        title: "More Oscillators",
                        text: "Increasing <span class='math'>n</span> adds more oscillators. With <span class='highlight'>k = 1</span>, the circle becomes smoother. Watch how 16 oscillators create a nearly perfect ring.",
                        duration: 6000,
                        params: { coupling: 1, n: 16, trailLength: 0, rainbowMode: false, theme: 'sunset', speed: 0.8, showApparentCircle: true },
                        transition: 1500
                    },
                    {
                        title: "Fewer Oscillators",
                        text: "With just <span class='math'>n = 3</span> oscillators at <span class='math'>k = 1</span>, we see a <span class='highlight'>triangular pattern</span> that still rotates as a unit.",
                        duration: 5500,
                        params: { n: 3, showPolygon: true, showApparentCircle: false, theme: 'dark' },
                        transition: 1000
                    },
                    {
                        title: "The Classic Setup",
                        text: "The famous \"Crazy Circle Illusion\" uses <span class='math'>n = 8</span> and <span class='math'>k = 1</span>. Each ball travels only on its line, but together they appear to orbit!",
                        duration: 6000,
                        params: { coupling: 1, n: 8, radius: 140, trailLength: 0, showPolygon: false, showLines: true, showApparentCircle: false, showCircleCenter: false, theme: 'orange', speed: 0.7, ballSize: 20 },
                        transition: 1500
                    },
                    {
                        title: "Explore on Your Own!",
                        text: "Now it's your turn! Adjust the <span class='highlight'>k slider</span> to break and restore the illusion. Try different <span class='highlight'>n values</span>, enable <span class='highlight'>trails</span>, and discover your own patterns.",
                        duration: 6000,
                        params: { coupling: 1, n: 8, radius: 120, trailLength: 0, theme: 'dark', speed: 1, ballSize: 16, showLines: true, rainbowMode: false },
                        transition: 1000
                    }
                ];
            }

            startDemo() {
                if (this.demoMode) return;
                
                // Store current params to restore later
                this.demoStartParams = JSON.parse(JSON.stringify(this.params));
                
                this.demoMode = true;
                this.demoStep = 0;
                this.isPaused = false;
                this.trailHistory = [];
                
                // Setup UI
                document.getElementById('btn-demo').classList.add('active');
                document.getElementById('btn-demo').innerHTML = '‚ñ† Exit Demo';
                document.getElementById('demo-overlay').classList.add('active');
                document.getElementById('main').classList.add('fullscreen');
                document.getElementById('coupling-indicator').classList.add('hidden');
                
                // Create progress dots
                const progressContainer = document.getElementById('demo-progress');
                progressContainer.innerHTML = '';
                this.demoSequence.forEach((_, i) => {
                    const dot = document.createElement('div');
                    dot.className = 'demo-progress-dot' + (i === 0 ? ' active' : '');
                    progressContainer.appendChild(dot);
                });
                
                this.runDemoStep();
            }

            stopDemo() {
                if (!this.demoMode) return;
                
                this.demoMode = false;
                clearTimeout(this.demoTimer);
                
                // Restore UI
                document.getElementById('btn-demo').classList.remove('active');
                document.getElementById('btn-demo').innerHTML = '‚ñ∂ Demo Mode';
                document.getElementById('demo-overlay').classList.remove('active');
                document.getElementById('main').classList.remove('fullscreen');
                document.getElementById('coupling-indicator').classList.remove('hidden');
                
                // Restore original params
                if (this.demoStartParams) {
                    Object.assign(this.params, this.demoStartParams);
                    this.updateUI();
                    this.updateCouplingIndicator();
                }
                
                this.trailHistory = [];
                this.showToast('Demo ended');
            }

            updateDemoMath() {
                if (!this.demoMode) return;
                
                const k = this.params.coupling;
                const n = Math.round(this.params.n);
                const r = Math.round(this.params.radius);
                const speed = this.params.speed;
                const isPerfect = Math.abs(k - 1.0) < 0.05;
                
                document.getElementById('dm-n').textContent = `n = ${n}`;
                document.getElementById('dm-k').textContent = `k = ${k.toFixed(2)}`;
                document.getElementById('dm-r').textContent = `R = ${r}px`;
                document.getElementById('dm-omega').textContent = `œâ = ${speed.toFixed(1)}√ó`;
                document.getElementById('dm-phase-eq').textContent = `${k.toFixed(2)} √ó Œ±·µ¢`;
                
                const statusEl = document.getElementById('dm-status');
                const kEl = document.getElementById('dm-k');
                
                if (isPerfect) {
                    statusEl.className = 'demo-math-status perfect';
                    statusEl.textContent = '‚úì Perfect Circle Illusion';
                    kEl.className = 'demo-math-value green';
                } else if (k === 0) {
                    statusEl.className = 'demo-math-status broken';
                    statusEl.textContent = '‚ü≥ All In Sync (No Illusion)';
                    kEl.className = 'demo-math-value cyan';
                } else {
                    statusEl.className = 'demo-math-status broken';
                    statusEl.textContent = '‚úó Illusion Broken';
                    kEl.className = 'demo-math-value coral';
                }
            }

            runDemoStep() {
                if (!this.demoMode || this.demoStep >= this.demoSequence.length) {
                    this.stopDemo();
                    return;
                }
                
                const step = this.demoSequence[this.demoStep];
                
                // Update chapter indicator
                document.getElementById('demo-chapter').textContent = `Chapter ${this.demoStep + 1} of ${this.demoSequence.length}`;
                
                // Update narration
                document.getElementById('demo-title').textContent = step.title;
                document.getElementById('demo-text').innerHTML = step.text;
                
                // Update progress dots
                const dots = document.querySelectorAll('.demo-progress-dot');
                dots.forEach((dot, i) => {
                    dot.classList.remove('active', 'complete');
                    if (i < this.demoStep) dot.classList.add('complete');
                    if (i === this.demoStep) dot.classList.add('active');
                });
                
                // Animate parameters
                this.animateToParams(step.params, step.transition);
                
                // Initial math update
                this.updateDemoMath();
                
                // Schedule next step
                this.demoTimer = setTimeout(() => {
                    this.demoStep++;
                    this.runDemoStep();
                }, step.duration);
            }

            animateToParams(targetParams, duration) {
                const startParams = JSON.parse(JSON.stringify(this.params));
                const startTime = performance.now();
                
                // Immediate non-animatable changes
                if (targetParams.theme !== undefined) this.params.theme = targetParams.theme;
                if (targetParams.rainbowMode !== undefined) this.params.rainbowMode = targetParams.rainbowMode;
                if (targetParams.showLines !== undefined) this.params.showLines = targetParams.showLines;
                if (targetParams.showApparentCircle !== undefined) this.params.showApparentCircle = targetParams.showApparentCircle;
                if (targetParams.showCircleCenter !== undefined) this.params.showCircleCenter = targetParams.showCircleCenter;
                if (targetParams.showPolygon !== undefined) this.params.showPolygon = targetParams.showPolygon;
                if (targetParams.showGlow !== undefined) this.params.showGlow = targetParams.showGlow;
                
                // Clear trails when changing coupling or n
                if (targetParams.coupling !== undefined || targetParams.n !== undefined) {
                    this.trailHistory = [];
                }
                
                const animate = () => {
                    if (!this.demoMode) return;
                    
                    const elapsed = performance.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const eased = this.easeInOutCubic(progress);
                    
                    // Animate numeric params
                    const animatable = ['coupling', 'n', 'radius', 'speed', 'trailLength', 'ballSize'];
                    animatable.forEach(key => {
                        if (targetParams[key] !== undefined) {
                            const start = startParams[key];
                            const end = targetParams[key];
                            this.params[key] = start + (end - start) * eased;
                            if (key === 'n') this.params[key] = Math.round(this.params[key]);
                            if (key === 'trailLength') this.params[key] = Math.round(this.params[key]);
                        }
                    });
                    
                    this.updateUI();
                    this.updateCouplingIndicator();
                    this.updateDemoMath();
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                
                animate();
            }

            easeInOutCubic(t) {
                return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
            }

            // ==================== END DEMO MODE ====================

            loop() {
                if (!this.isPaused) this.t += 0.025 * this.params.speed;
                this.draw();
                requestAnimationFrame(() => this.loop());
            }

            toggleRecord() {
                const btn = document.getElementById('btn-record');
                if (this.isRecording) {
                    this.stopRecording();
                    btn.classList.remove('recording');
                    btn.innerHTML = '<span>‚óè</span> Start Recording';
                } else {
                    this.startRecording();
                    btn.classList.add('recording');
                    btn.innerHTML = '<span>‚ñ†</span> Stop & Save';
                }
            }

            startRecording() {
                this.chunks = [];
                const stream = this.canvas.captureStream(60);
                let options = { mimeType: 'video/webm' };
                if (MediaRecorder.isTypeSupported('video/webm; codecs=vp9')) {
                    options.mimeType = 'video/webm; codecs=vp9';
                }
                this.mediaRecorder = new MediaRecorder(stream, options);
                this.mediaRecorder.ondataavailable = e => { if (e.data.size > 0) this.chunks.push(e.data); };
                this.mediaRecorder.onstop = () => {
                    const blob = new Blob(this.chunks, { type: 'video/webm' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `coupled_oscillator_k${this.params.coupling}_n${this.params.n}_${Date.now()}.webm`;
                    a.click();
                    this.showToast('Recording saved!');
                };
                this.mediaRecorder.start();
                this.isRecording = true;
                this.showToast('Recording started...');
            }

            stopRecording() {
                this.mediaRecorder.stop();
                this.isRecording = false;
            }
        }

        new CoupledOscillatorApp();
    </script>
</body>
</html>
